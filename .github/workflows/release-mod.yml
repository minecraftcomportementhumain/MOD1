name: Build and Release Mod

on:
  push:
    branches:
      - main  # Se déclenche à chaque push sur main
  workflow_dispatch:  # Permet de lancer manuellement

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT

      - name: Delete old 'latest' release
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            try {
              const release = await github.rest.repos.getReleaseByTag({
                owner,
                repo,
                tag: 'latest'
              });
              await github.rest.repos.deleteRelease({
                owner,
                repo,
                release_id: release.data.id
              });
              console.log('Deleted old release');
            } catch (error) {
              console.log('No previous release to delete');
            }

            try {
              await github.rest.git.deleteRef({
                owner,
                repo,
                ref: 'tags/latest'
              });
              console.log('Deleted old tag');
            } catch (error) {
              console.log('No previous tag to delete');
            }

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "Latest Build - ${{ steps.date.outputs.date }}"
          body_path: RELEASE_NOTES.md
          files: |
            build/libs/*.jar
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
